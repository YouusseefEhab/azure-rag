- name: Azure Login
  uses: azure/login@v2
  with:
    creds: ${{ secrets.AZURE_CREDENTIALS }}

- name: Set GHCR registry on Container App
  shell: bash
  env:
    RG: ${{ secrets.RESOURCE_GROUP }}
    APP: ${{ secrets.CONTAINER_APP_NAME }}
    GHCR_USERNAME: ${{ secrets.GHCR_USERNAME }}
    GHCR_TOKEN: ${{ secrets.GHCR_TOKEN }}
  run: |
    for v in RG APP GHCR_USERNAME GHCR_TOKEN; do
      if [ -z "${!v}" ]; then echo "::error::$v is empty"; exit 1; fi
    done
    az containerapp registry set \
      -g "$RG" -n "$APP" \
      --server ghcr.io \
      --username "$GHCR_USERNAME" \
      --password "$GHCR_TOKEN"

- name: Deploy image (owner must be lowercase)
  shell: bash
  env:
    RG: ${{ secrets.RESOURCE_GROUP }}
    APP: ${{ secrets.CONTAINER_APP_NAME }}
  run: |
    OWNER=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
    IMAGE="ghcr.io/$OWNER/azure-rag:${{ github.sha }}"
    az containerapp update -g "$RG" -n "$APP" \
      --image "$IMAGE" --cpu 1 --memory 2Gi --min-replicas 1
    az containerapp ingress update -g "$RG" -n "$APP" \
      --type external --target-port 8080 --exposed
